<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>å¸å®‰Kçº¿å›¾ - ä¸“ä¸šç‰ˆ</title>
    <style type="text/css">
      :root {
        --bg-primary: #ffffff;
        --bg-secondary: #f9f9f9;
        --text-primary: #333333;
        --text-secondary: #666666;
        --border-color: #e0e0e0;
        --grid-color: rgba(200, 200, 200, 0.3);
        --up-color: #26a69a;
        --down-color: #ef5350;
        --ma5-color: #FF9800;
        --ma10-color: #2196F3;
        --ma30-color: #9C27B0;
      }

      body.dark {
        --bg-primary: #1e1e1e;
        --bg-secondary: #2d2d30;
        --text-primary: #ffffff;
        --text-secondary: #cccccc;
        --border-color: #444444;
        --grid-color: rgba(100, 100, 100, 0.3);
        --up-color: #26a69a;
        --down-color: #ef5350;
      }

      body {
        margin: 0;
        padding: 10px;
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
        background: var(--bg-primary);
        color: var(--text-primary);
        transition: background 0.3s, color 0.3s;
      }

      .header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 10px 15px;
        background: var(--bg-secondary);
        border-radius: 8px;
        margin-bottom: 10px;
      }

      .controls {
        display: flex;
        gap: 15px;
        align-items: center;
      }

      .period-group {
        display: flex;
        gap: 5px;
      }

      .period-btn {
        padding: 5px 10px;
        background: transparent;
        border: 1px solid var(--border-color);
        color: var(--text-primary);
        cursor: pointer;
        border-radius: 4px;
        transition: all 0.2s;
      }

      .period-btn:hover {
        background: var(--border-color);
      }

      .period-btn.active {
        background: var(--up-color);
        color: white;
        border-color: var(--up-color);
      }

      .indicators {
        display: flex;
        gap: 10px;
      }

      .indicator-toggle {
        display: flex;
        align-items: center;
        gap: 5px;
        cursor: pointer;
      }

      .indicator-toggle input {
        cursor: pointer;
      }

      .theme-switch {
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .switch {
        position: relative;
        width: 50px;
        height: 24px;
      }

      .switch input {
        opacity: 0;
        width: 0;
        height: 0;
      }

      .slider {
        position: absolute;
        cursor: pointer;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: #ccc;
        transition: .4s;
        border-radius: 34px;
      }

      .slider:before {
        position: absolute;
        content: "";
        height: 18px;
        width: 18px;
        left: 3px;
        bottom: 3px;
        background-color: white;
        transition: .4s;
        border-radius: 50%;
      }

      input:checked + .slider {
        background-color: var(--up-color);
      }

      input:checked + .slider:before {
        transform: translateX(26px);
      }

      .chart-container {
        position: relative;
        border: 1px solid var(--border-color);
        border-radius: 8px;
        overflow: hidden;
        background: var(--bg-primary);
      }

      #mainChart, #volumeChart {
        display: block;
        cursor: crosshair;
      }

      .info-panel {
        position: absolute;
        top: 10px;
        left: 10px;
        background: rgba(0, 0, 0, 0.7);
        color: white;
        padding: 10px 15px;
        border-radius: 5px;
        font-size: 12px;
        pointer-events: none;
      }

      .info-row {
        display: flex;
        gap: 15px;
        margin: 3px 0;
      }

      .info-item {
        display: flex;
        gap: 5px;
      }

      .info-label {
        opacity: 0.8;
      }

      .info-value {
        font-weight: bold;
      }

      .ma-value {
        padding: 2px 5px;
        border-radius: 3px;
      }

      .status-bar {
        margin-top: 10px;
        padding: 8px 15px;
        background: var(--bg-secondary);
        border-radius: 8px;
        font-size: 12px;
        color: var(--text-secondary);
        display: flex;
        justify-content: space-between;
      }

      .help-panel {
        position: fixed;
        bottom: 20px;
        right: 20px;
        background: rgba(0, 0, 0, 0.9);
        color: white;
        padding: 15px;
        border-radius: 8px;
        font-size: 11px;
        max-width: 200px;
      }

      .help-panel h4 {
        margin: 0 0 10px 0;
        color: var(--up-color);
      }

      .help-item {
        margin: 5px 0;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .key {
        background: #444;
        padding: 2px 6px;
        border-radius: 3px;
        font-weight: bold;
        min-width: 20px;
        text-align: center;
      }
    </style>
</head>
<body>
    <div class="header">
        <div class="controls">
            <select id="symbol" onchange="updateSymbol()">
                <option value="BTCUSDT:1:3">BTC/USDT</option>
                <option value="ETHUSDT:2:3">ETH/USDT</option>
                <option value="SOLUSDT:2:0">SOL/USDT</option>
                <option value="BNBUSDT:2:2">BNB/USDT</option>
                <option value="XRPUSDT:4:1">XRP/USDT</option>
                <option value="DOGEUSDT:5:0">DOGE/USDT</option>
                <option value="ADAUSDT:4:1">ADA/USDT</option>
                <option value="AVAXUSDT:3:1">AVAX/USDT</option>
                <option value="DOTUSDT:3:1">DOT/USDT</option>
                <option value="MATICUSDT:4:0">MATIC/USDT</option>
            </select>

            <div class="period-group">
                <button class="period-btn" data-period="1m">1åˆ†</button>
                <button class="period-btn" data-period="5m">5åˆ†</button>
                <button class="period-btn active" data-period="15m">15åˆ†</button>
                <button class="period-btn" data-period="30m">30åˆ†</button>
                <button class="period-btn" data-period="1h">1æ—¶</button>
                <button class="period-btn" data-period="4h">4æ—¶</button>
                <button class="period-btn" data-period="1d">1æ—¥</button>
                <button class="period-btn" data-period="1w">1å‘¨</button>
            </div>
        </div>

        <div class="indicators">
            <label class="indicator-toggle">
                <input type="checkbox" id="showMA" checked> MAå‡çº¿
            </label>
            <label class="indicator-toggle">
                <input type="checkbox" id="showVolume" checked> æˆäº¤é‡
            </label>
            <label class="indicator-toggle">
                <input type="checkbox" id="showGrid" checked> ç½‘æ ¼
            </label>
        </div>

        <div class="theme-switch">
            <span>ğŸŒ™</span>
            <label class="switch">
                <input type="checkbox" id="themeToggle">
                <span class="slider"></span>
            </label>
            <span>â˜€ï¸</span>
        </div>
    </div>

    <div class="chart-container">
        <canvas id="mainChart" width="1400" height="500"></canvas>
        <canvas id="volumeChart" width="1400" height="100"></canvas>

        <div class="info-panel" id="infoPanel">
            <div class="info-row">
                <div class="info-item">
                    <span class="info-label">å¼€:</span>
                    <span class="info-value" id="openPrice">-</span>
                </div>
                <div class="info-item">
                    <span class="info-label">é«˜:</span>
                    <span class="info-value" id="highPrice">-</span>
                </div>
                <div class="info-item">
                    <span class="info-label">ä½:</span>
                    <span class="info-value" id="lowPrice">-</span>
                </div>
                <div class="info-item">
                    <span class="info-label">æ”¶:</span>
                    <span class="info-value" id="closePrice">-</span>
                </div>
                <div class="info-item">
                    <span class="info-label">é‡:</span>
                    <span class="info-value" id="volume">-</span>
                </div>
            </div>
            <div class="info-row" id="maInfo">
                <span class="ma-value" style="color: var(--ma5-color)">MA5: <span id="ma5">-</span></span>
                <span class="ma-value" style="color: var(--ma10-color)">MA10: <span id="ma10">-</span></span>
                <span class="ma-value" style="color: var(--ma30-color)">MA30: <span id="ma30">-</span></span>
            </div>
        </div>
    </div>

    <div class="status-bar">
        <span id="statusLeft">å°±ç»ª</span>
        <span id="statusRight">æŒ‰ H æ˜¾ç¤º/éšè—å¸®åŠ©</span>
    </div>

    <div class="help-panel" id="helpPanel">
        <h4>å¿«æ·é”®æŒ‡å—</h4>
        <div class="help-item"><span class="key">D</span> æ”¾å¤§</div>
        <div class="help-item"><span class="key">F</span> ç¼©å°</div>
        <div class="help-item"><span class="key">â†â†’</span> ç§»åŠ¨</div>
        <div class="help-item"><span class="key">â†‘â†“</span> ç¼©æ”¾Yè½´</div>
        <div class="help-item"><span class="key">R</span> é‡ç½®è§†å›¾</div>
        <div class="help-item"><span class="key">G</span> ç½‘æ ¼å¼€å…³</div>
        <div class="help-item"><span class="key">M</span> MAå¼€å…³</div>
        <div class="help-item"><span class="key">V</span> æˆäº¤é‡å¼€å…³</div>
        <div class="help-item"><span class="key">H</span> éšè—å¸®åŠ©</div>
    </div>

    <script>
      // å…¨å±€å˜é‡
      let symbol = "BTCUSDT";
      let period = "15m";
      let symbolPricePoint = 1;
      let symbolQuantityPoint = 3;
      let klineData = [];
      let mainCtx, volumeCtx;

      // è§†å›¾æ§åˆ¶
      let chartOffset = 0;
      let candleWidth = 8;
      let candleSpacing = 2;
      let isDragging = false;
      let dragStartX = 0;

      // MAæ•°æ®ç¼“å­˜
      let ma5Data = [];
      let ma10Data = [];
      let ma30Data = [];

      // æ˜¾ç¤ºæ§åˆ¶
      let showMA = true;
      let showVolume = true;
      let showGrid = true;
      let showCrosshair = true;
      let mouseX = 0, mouseY = 0;

      // MAè®¡ç®—
      function calculateMA(data, period) {
        const ma = [];
        for (let i = 0; i < data.length; i++) {
          if (i < period - 1) {
            ma.push(null);
            continue;
          }
          let sum = 0;
          for (let j = 0; j < period; j++) {
            sum += parseFloat(data[i - j][4]); // close price
          }
          ma.push(sum / period);
        }
        return ma;
      }

      // ç»˜åˆ¶ä¸»å›¾
      function drawMainChart() {
        const canvas = document.getElementById('mainChart');
        const width = canvas.width;
        const height = canvas.height;

        mainCtx.clearRect(0, 0, width, height);

        if (!klineData || klineData.length === 0) return;

        // è®¡ç®—æ˜¾ç¤ºèŒƒå›´
        const totalWidth = candleWidth + candleSpacing;
        const visibleCount = Math.floor(width / totalWidth);
        const startIdx = Math.max(0, klineData.length - visibleCount + chartOffset);
        const endIdx = Math.min(klineData.length, startIdx + visibleCount);

        // æ‰¾å‡ºä»·æ ¼èŒƒå›´
        let maxPrice = 0, minPrice = Infinity;
        for (let i = startIdx; i < endIdx; i++) {
          const high = parseFloat(klineData[i][2]);
          const low = parseFloat(klineData[i][3]);
          maxPrice = Math.max(maxPrice, high);
          minPrice = Math.min(minPrice, low);
        }

        const priceRange = maxPrice - minPrice;
        const padding = priceRange * 0.1;
        maxPrice += padding;
        minPrice -= padding;

        // ç»˜åˆ¶ç½‘æ ¼
        if (showGrid) {
          mainCtx.strokeStyle = getComputedStyle(document.body).getPropertyValue('--grid-color');
          mainCtx.lineWidth = 0.5;
          mainCtx.setLineDash([2, 2]);

          // æ¨ªå‘ç½‘æ ¼çº¿
          for (let i = 0; i <= 10; i++) {
            const y = (height / 10) * i;
            mainCtx.beginPath();
            mainCtx.moveTo(0, y);
            mainCtx.lineTo(width, y);
            mainCtx.stroke();

            // ä»·æ ¼æ ‡ç­¾
            const price = maxPrice - ((maxPrice - minPrice) / 10) * i;
            mainCtx.fillStyle = getComputedStyle(document.body).getPropertyValue('--text-secondary');
            mainCtx.font = '11px Arial';
            mainCtx.fillText(price.toFixed(symbolPricePoint), width - 60, y + 3);
          }

          mainCtx.setLineDash([]);
        }

        // ç»˜åˆ¶Kçº¿
        for (let i = startIdx; i < endIdx; i++) {
          const idx = i - startIdx;
          const x = idx * totalWidth + totalWidth / 2;

          const open = parseFloat(klineData[i][1]);
          const high = parseFloat(klineData[i][2]);
          const low = parseFloat(klineData[i][3]);
          const close = parseFloat(klineData[i][4]);

          const yHigh = ((maxPrice - high) / (maxPrice - minPrice)) * height;
          const yLow = ((maxPrice - low) / (maxPrice - minPrice)) * height;
          const yOpen = ((maxPrice - open) / (maxPrice - minPrice)) * height;
          const yClose = ((maxPrice - close) / (maxPrice - minPrice)) * height;

          // è®¾ç½®é¢œè‰²
          const isUp = close >= open;
          mainCtx.strokeStyle = isUp ? getComputedStyle(document.body).getPropertyValue('--up-color')
                                    : getComputedStyle(document.body).getPropertyValue('--down-color');
          mainCtx.fillStyle = mainCtx.strokeStyle;
          mainCtx.lineWidth = 1;

          // ç”»å½±çº¿
          mainCtx.beginPath();
          mainCtx.moveTo(x, yHigh);
          mainCtx.lineTo(x, yLow);
          mainCtx.stroke();

          // ç”»å®ä½“
          const bodyHeight = Math.abs(yClose - yOpen) || 1;
          const bodyY = Math.min(yOpen, yClose);

          if (isUp) {
            mainCtx.strokeRect(x - candleWidth/2, bodyY, candleWidth, bodyHeight);
          } else {
            mainCtx.fillRect(x - candleWidth/2, bodyY, candleWidth, bodyHeight);
          }
        }

        // è®¡ç®—å¹¶ç»˜åˆ¶MAå‡çº¿
        if (showMA && klineData.length > 0) {
          // è®¡ç®—MAå€¼ï¼ˆåªåœ¨æ•°æ®æ›´æ–°æ—¶é‡ç®—ï¼‰
          if (ma5Data.length !== klineData.length) {
            ma5Data = calculateMA(klineData, 5);
            ma10Data = calculateMA(klineData, 10);
            ma30Data = calculateMA(klineData, 30);
          }

          // ç»˜åˆ¶MA5
          drawMALine(ma5Data, startIdx, endIdx, maxPrice, minPrice, height, totalWidth, '--ma5-color');
          // ç»˜åˆ¶MA10
          drawMALine(ma10Data, startIdx, endIdx, maxPrice, minPrice, height, totalWidth, '--ma10-color');
          // ç»˜åˆ¶MA30
          drawMALine(ma30Data, startIdx, endIdx, maxPrice, minPrice, height, totalWidth, '--ma30-color');

          // æ›´æ–°æœ€æ–°çš„MAå€¼åˆ°é¢æ¿
          const lastIdx = klineData.length - 1;
          if (lastIdx >= 0) {
            document.getElementById('ma5').textContent = ma5Data[lastIdx] ? ma5Data[lastIdx].toFixed(symbolPricePoint) : '-';
            document.getElementById('ma10').textContent = ma10Data[lastIdx] ? ma10Data[lastIdx].toFixed(symbolPricePoint) : '-';
            document.getElementById('ma30').textContent = ma30Data[lastIdx] ? ma30Data[lastIdx].toFixed(symbolPricePoint) : '-';
          }
        }

        // ç»˜åˆ¶åå­—å…‰æ ‡
        if (showCrosshair && mouseX > 0 && mouseY > 0) {
          mainCtx.strokeStyle = 'rgba(255, 255, 255, 0.3)';
          mainCtx.lineWidth = 0.5;
          mainCtx.setLineDash([5, 5]);

          // å‚ç›´çº¿
          mainCtx.beginPath();
          mainCtx.moveTo(mouseX, 0);
          mainCtx.lineTo(mouseX, height);
          mainCtx.stroke();

          // æ°´å¹³çº¿
          mainCtx.beginPath();
          mainCtx.moveTo(0, mouseY);
          mainCtx.lineTo(width, mouseY);
          mainCtx.stroke();

          mainCtx.setLineDash([]);

          // æ˜¾ç¤ºä»·æ ¼
          const price = maxPrice - ((mouseY / height) * (maxPrice - minPrice));
          mainCtx.fillStyle = 'rgba(0, 0, 0, 0.7)';
          mainCtx.fillRect(width - 70, mouseY - 10, 65, 20);
          mainCtx.fillStyle = 'white';
          mainCtx.font = 'bold 11px Arial';
          mainCtx.fillText(price.toFixed(symbolPricePoint), width - 65, mouseY + 3);

          // æ›´æ–°ä¿¡æ¯é¢æ¿ï¼ˆé¼ æ ‡æ‚¬åœæ—¶ï¼‰
          const candleIdx = Math.floor(mouseX / totalWidth) + startIdx;
          if (candleIdx >= startIdx && candleIdx < endIdx && candleIdx < klineData.length) {
            updateInfoPanel(klineData[candleIdx], ma5Data[candleIdx], ma10Data[candleIdx], ma30Data[candleIdx]);
          }
        }
      }

      // ç»˜åˆ¶MAçº¿
      function drawMALine(maData, startIdx, endIdx, maxPrice, minPrice, height, totalWidth, colorVar) {
        mainCtx.strokeStyle = getComputedStyle(document.body).getPropertyValue(colorVar);
        mainCtx.lineWidth = 1.5;
        mainCtx.beginPath();

        let firstPoint = true;
        for (let i = startIdx; i < endIdx; i++) {
          if (maData[i] === null) continue;

          const x = (i - startIdx) * totalWidth + totalWidth / 2;
          const y = ((maxPrice - maData[i]) / (maxPrice - minPrice)) * height;

          if (firstPoint) {
            mainCtx.moveTo(x, y);
            firstPoint = false;
          } else {
            mainCtx.lineTo(x, y);
          }
        }
        mainCtx.stroke();
      }

      // ç»˜åˆ¶æˆäº¤é‡å›¾
      function drawVolumeChart() {
        const canvas = document.getElementById('volumeChart');
        const width = canvas.width;
        const height = canvas.height;

        volumeCtx.clearRect(0, 0, width, height);

        if (!klineData || klineData.length === 0 || !showVolume) return;

        // è®¡ç®—æ˜¾ç¤ºèŒƒå›´
        const totalWidth = candleWidth + candleSpacing;
        const visibleCount = Math.floor(width / totalWidth);
        const startIdx = Math.max(0, klineData.length - visibleCount + chartOffset);
        const endIdx = Math.min(klineData.length, startIdx + visibleCount);

        // æ‰¾å‡ºæœ€å¤§æˆäº¤é‡
        let maxVolume = 0;
        for (let i = startIdx; i < endIdx; i++) {
          const volume = parseFloat(klineData[i][5]);
          maxVolume = Math.max(maxVolume, volume);
        }

        // ç»˜åˆ¶æˆäº¤é‡æŸ±
        for (let i = startIdx; i < endIdx; i++) {
          const idx = i - startIdx;
          const x = idx * totalWidth + totalWidth / 2;
          const volume = parseFloat(klineData[i][5]);
          const barHeight = (volume / maxVolume) * height * 0.8;

          const open = parseFloat(klineData[i][1]);
          const close = parseFloat(klineData[i][4]);
          const isUp = close >= open;

          volumeCtx.fillStyle = isUp ? getComputedStyle(document.body).getPropertyValue('--up-color')
                                     : getComputedStyle(document.body).getPropertyValue('--down-color');
          volumeCtx.fillRect(x - candleWidth/2, height - barHeight, candleWidth, barHeight);
        }
      }

      // æ›´æ–°ä¿¡æ¯é¢æ¿
      function updateInfoPanel(candle, ma5, ma10, ma30) {
        if (!candle) return;

        document.getElementById('openPrice').textContent = parseFloat(candle[1]).toFixed(symbolPricePoint);
        document.getElementById('highPrice').textContent = parseFloat(candle[2]).toFixed(symbolPricePoint);
        document.getElementById('lowPrice').textContent = parseFloat(candle[3]).toFixed(symbolPricePoint);
        document.getElementById('closePrice').textContent = parseFloat(candle[4]).toFixed(symbolPricePoint);
        document.getElementById('volume').textContent = parseFloat(candle[5]).toFixed(2);

        document.getElementById('ma5').textContent = ma5 ? ma5.toFixed(symbolPricePoint) : '-';
        document.getElementById('ma10').textContent = ma10 ? ma10.toFixed(symbolPricePoint) : '-';
        document.getElementById('ma30').textContent = ma30 ? ma30.toFixed(symbolPricePoint) : '-';
      }

      // æ›´æ–°æ•°æ®
      function updateChart() {
        const xhr = new XMLHttpRequest();
        xhr.onreadystatechange = function() {
          if (xhr.readyState === 4) {
            try {
              const response = JSON.parse(xhr.response);
              if (response.retcode === 0) {
                klineData = response.data;
                // é‡ç½®MAç¼“å­˜ï¼Œå¼ºåˆ¶é‡æ–°è®¡ç®—
                ma5Data = [];
                ma10Data = [];
                ma30Data = [];

                drawMainChart();
                drawVolumeChart();
                updateStatus(`${symbol} - ${period} - ${klineData.length} æ ¹Kçº¿`);

                // æ˜¾ç¤ºæœ€æ–°Kçº¿çš„ä¿¡æ¯
                if (klineData.length > 0) {
                  const lastCandle = klineData[klineData.length - 1];
                  updateInfoPanel(lastCandle, null, null, null);
                }
              }
            } catch (e) {
              console.error('æ•°æ®è§£æé”™è¯¯:', e);
            }
          }
        };
        xhr.open('POST', '/chart', true);
        xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
        xhr.send(`symbol=${symbol}&period=${period}&version=1`);
      }

      // æ›´æ–°çŠ¶æ€æ 
      function updateStatus(text) {
        document.getElementById('statusLeft').textContent = `${new Date().toLocaleTimeString('zh-CN')} - ${text}`;
      }

      // æ›´æ–°å¸ç§
      function updateSymbol() {
        const sel = document.getElementById('symbol');
        const arr = sel.value.split(':');
        symbol = arr[0];
        symbolPricePoint = parseInt(arr[1]);
        symbolQuantityPoint = parseInt(arr[2]);
        chartOffset = 0;
        updateChart();
      }

      // åˆå§‹åŒ–
      window.onload = function() {
        mainCtx = document.getElementById('mainChart').getContext('2d');
        volumeCtx = document.getElementById('volumeChart').getContext('2d');

        // å‘¨æœŸæŒ‰é’®
        document.querySelectorAll('.period-btn').forEach(btn => {
          btn.addEventListener('click', function() {
            document.querySelectorAll('.period-btn').forEach(b => b.classList.remove('active'));
            this.classList.add('active');
            period = this.dataset.period;
            chartOffset = 0;
            updateChart();
          });
        });

        // ä¸»é¢˜åˆ‡æ¢
        document.getElementById('themeToggle').addEventListener('change', function() {
          document.body.classList.toggle('dark', this.checked);
          drawMainChart();
          drawVolumeChart();
        });

        // æŒ‡æ ‡å¼€å…³
        document.getElementById('showMA').addEventListener('change', function() {
          showMA = this.checked;
          drawMainChart();
        });

        document.getElementById('showVolume').addEventListener('change', function() {
          showVolume = this.checked;
          drawVolumeChart();
        });

        document.getElementById('showGrid').addEventListener('change', function() {
          showGrid = this.checked;
          drawMainChart();
        });

        // é¼ æ ‡äº‹ä»¶
        const mainCanvas = document.getElementById('mainChart');

        mainCanvas.addEventListener('mousedown', function(e) {
          isDragging = true;
          dragStartX = e.clientX;
          this.style.cursor = 'grabbing';
        });

        mainCanvas.addEventListener('mouseup', function() {
          isDragging = false;
          this.style.cursor = 'crosshair';
        });

        mainCanvas.addEventListener('mouseleave', function() {
          isDragging = false;
          mouseX = 0;
          mouseY = 0;
          this.style.cursor = 'crosshair';
          drawMainChart();
        });

        mainCanvas.addEventListener('mousemove', function(e) {
          const rect = this.getBoundingClientRect();
          mouseX = e.clientX - rect.left;
          mouseY = e.clientY - rect.top;

          if (isDragging) {
            const dx = e.clientX - dragStartX;
            if (Math.abs(dx) > 5) {
              chartOffset += Math.floor(dx / 5);
              chartOffset = Math.min(0, Math.max(chartOffset, -(klineData.length - 50)));
              dragStartX = e.clientX;
            }
          }
          drawMainChart();
        });

        // æ»šè½®ç¼©æ”¾
        mainCanvas.addEventListener('wheel', function(e) {
          e.preventDefault();
          if (e.deltaY < 0) {
            candleWidth = Math.min(20, candleWidth + 1);
          } else {
            candleWidth = Math.max(2, candleWidth - 1);
          }
          drawMainChart();
          drawVolumeChart();
        });

        // é”®ç›˜å¿«æ·é”®
        document.addEventListener('keydown', function(e) {
          switch(e.keyCode) {
            case 68: // D - æ”¾å¤§
              candleWidth = Math.min(20, candleWidth + 1);
              drawMainChart();
              drawVolumeChart();
              break;
            case 70: // F - ç¼©å°
              candleWidth = Math.max(2, candleWidth - 1);
              drawMainChart();
              drawVolumeChart();
              break;
            case 37: // å·¦ç®­å¤´
              chartOffset = Math.max(chartOffset - 5, -(klineData.length - 50));
              drawMainChart();
              drawVolumeChart();
              break;
            case 39: // å³ç®­å¤´
              chartOffset = Math.min(0, chartOffset + 5);
              drawMainChart();
              drawVolumeChart();
              break;
            case 82: // R - é‡ç½®
              chartOffset = 0;
              candleWidth = 8;
              drawMainChart();
              drawVolumeChart();
              break;
            case 71: // G - ç½‘æ ¼
              showGrid = !showGrid;
              document.getElementById('showGrid').checked = showGrid;
              drawMainChart();
              break;
            case 77: // M - MA
              showMA = !showMA;
              document.getElementById('showMA').checked = showMA;
              drawMainChart();
              break;
            case 86: // V - æˆäº¤é‡
              showVolume = !showVolume;
              document.getElementById('showVolume').checked = showVolume;
              drawVolumeChart();
              break;
            case 72: // H - å¸®åŠ©
              const help = document.getElementById('helpPanel');
              help.style.display = help.style.display === 'none' ? 'block' : 'none';
              break;
          }
        });

        // å®šæ—¶æ›´æ–°
        updateChart();
        setInterval(updateChart, 10000);
      };
    </script>
</body>
</html>